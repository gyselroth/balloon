# RFC1 End-To-End Encryption

**ID**: RFC1 \
**Author**: Raffael Sahli <sahli@gyselroth.net> \
**Copyright**: gyselroth GmbH 2018

## Description
This document describes an implementation of a secure client based End-To-End encryption for balloon.
This document only describes the theory how a possible implementation CAN work and does not specify what exact technology SHALL be used.

## Concept

### Keys
The actual encryption is implemented in balloon-client-desktop. The server acts as a keyserver and only provides public keys for users. Meaning the servers only job is to provide and storing public keys.
Each balloon-client-desktop installation generates a public/private keypair. The public key automatically gets uploaded to the balloon server via the balloon HTTP API. Therefore a user can easily own multiple public/private keypairs.
The private key MUST never leave the orginal system where it has been created. The generation for a public/private keypair only happens once for each device instance. The keypair is stored in the local .balloon folder instance. Theoretically there could be multiple keypairs for each device but only one keypair CAN exists for each instance.

### Encryption
Only file contents get encrypted. Meta data MUST NOT be encrypted. Meaning file name, timestamps, tags, advanced meta attributes are still clear text. Folders are not affected by the encryption since only file content gets encrypted.
 
## Server

### Description
The balloon server acts as key server. A new app called Balloon.App.PublicKey is provided for that usage.

### API Endpoints
This very app provides following new API Endpoints:

#### Request registered devices

Request all registered devices owned by user who gets authenticated during the requst.
It is not possible to received any other devices than those owned by the user itself.

**Endpoint**: GET /api/v?/public-key/devices

Success response:
```
(number) status HTTP status code (200 for a successfuly response)
(array[]) data[] Array of device objects
(string) data.id Device id (server generates one)
(string) data.device_identifier (Defined by client)
(string) data.public_key (Public key uploaded by client)
```

Example request:
```
GET /api/v?/public-key/devices
HTTP/1.1 200 OK
{
    "status": 200,
    "data": [
        {	
            "id": "807f191e810c19729de860ea",
            "device_identifier": "myhostname (Linux Mint 17)",
            "public_key": "base64 encoded public key"
        }
    ]
}
```

### Create new device
Create a new client device. Parameters client_identifier and public_key MUST be provided.

**Endpoint**: PUT /api/v?/public-key?device_identitfier=:device_identifier&public_key=:public_key

Request parameters:
```
(string) device_identifier A device identifier (human readable)
(string) public_key Base64 encoded public key in pem format 
```

Success response:
```
(number) status HTTP status code (201 for a successfuly response)
(string) data The id generated by the server
```

Example request:
```
PUT /api/v?/public-key?device_identifier=Thinkpad%s204266%20Windows10&public_key=base64_encoded_pem_pubkey
HTTP/1.1 201 Created
{
    "status": 201,
    "data": "807f191e810c19729de860cc"
}
```

Possible error response:
* Device identifier already exists (400 Bad request)
* Publickey fingerprint already exists (400 Bad request)

### Delete device
Deletes an existing device by id. An id MUST be provided by the client to execute the request.
It COULD be possible that also the public key fingerprint is accepted.

**Endpoint**: DELETE /api/v?/public-key?id=:id

Request parameters:
```
(string) device_identifier A device identifier (human readable)
(string) public_key Base64 encoded public key in pem format 
```

Example request:
```
DELETE /api/v?/public-key?id=807f191e810c19729de860cc
HTTP/1.1 204 No Content
```

Possible error response:
* Device identifier does not exists (404 Not Found)

## Restrictions

### Server apps 
All server apps which work content based are not usable for encrypted content. Following apps are affected and not usable or only partially usable for encrypted files:
 
* Balloon.App.Preview \
The server is not able to generate previews for encrypted files

* Balloon.App.ClamAv \
Encrypted files can not be scanned for any malware/viruses

* Balloon.App.Elasticsearch \
Fulltext search is not possible due file encryption, however it is still possible to search for meta relevant information like tags, name, author.

* Balloon.App.Office \
Office formats like doc, docx, xls, xlsx, ppt, pptx are not editable nor viewable.

* Balloon.App.Convert \
No documents can be converted anymore by the server automatically. This is true for any document.

* Balloon.App.Sharelink \
World wide accessable links theoretically still work for encrypted files, however since the content is encrypted and can only be decrypted by specific clients the contents provided by those links would be unsuable.
