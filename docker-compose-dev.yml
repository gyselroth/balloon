version: '3'
networks:
  backend:
  frontend:

services:
  traefik:
    image: traefik:v2.1
    command: --providers.docker --entrypoints.http.Address=:80 --entrypoints.https.Address=:443
    ports:
      - "8084:80"
      - "4443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
    - backend
    - frontend
  mongodb:
    image: mongo:4.2
    entrypoint: [ "/usr/bin/mongod", "--bind_ip_all", "--replSet", "rs0" ]
    networks:
    - backend
  clamav:
    image: dinkel/clamavd:latest
    networks:
    - backend
  libreoffice-convert:
    image: collabora/code:4.0.8.2
    environment:
      - domain=localhost
      - extra_params=--o:ssl.termination=false --o:ssl.enable=false --o:net.post_allow.host[0]=::ffff:172.[0-9]+.[0-9]+.[0-9]+ --o:storage.wopi.host[2]=::ffff:172.[0-9]+.[0-9]+.[0-9]+"
    networks:
    - backend
  libreoffice-collab:
    image: collabora/code:4.0.8.2
    ports:
      - "9980:9980"
    environment:
      - domain=localhost
      - extra_params=--o:ssl.termination=false --o:ssl.enable=false --o:net.post_allow.host[0]=::ffff:172.[0-9]+.[0-9]+.[0-9]+ --o:storage.wopi.host[2]=::ffff:172.[0-9]+.[0-9]+.[0-9]+ --o:net.frame_ancestors="localhost:*"
    networks:
    - backend
    - frontend
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:6.6.1
    entrypoint:
      - /bin/sh
      - -c
      - "elasticsearch-plugin list | grep ingest-attachment || elasticsearch-plugin install ingest-attachment --batch && docker-entrypoint.sh"
    networks:
    - backend
  postfix:
    image: webuni/postfix
    networks:
    - backend
  browserless:
    image: browserless/chrome
    networks:
    - backend
  balloon-proxy:
    image: nginx
    networks:
    - backend
    command: |
      bash -c 'rm /etc/nginx/conf.d/default.conf; bash -s <<EOF
        cat > /etc/nginx/conf.d/balloon.conf <<EON
          server {
              listen 80;
              access_log /dev/stdout;
              error_log /dev/stderr;
              client_max_body_size 16G;

              location ~ ^/(api|webdav|wopi|share|openapi|auth) {
                  index index.php;
                  root /srv/www/balloon/src/httpdocs;
                  rewrite ^(.+)\\\$$ /index.php\\\$$1 last;
                  break;
              }

              location ~ ^/index.php {
                  root /srv/www/balloon/src/httpdocs;
                  fastcgi_pass balloon-api:9000;
                  fastcgi_read_timeout 300;
                  fastcgi_param SCRIPT_FILENAME /srv/www/balloon/src/httpdocs\\\$$fastcgi_script_name;
                  fastcgi_param PATH_INFO \\\$$fastcgi_script_name;
                  include /etc/nginx/fastcgi_params;
              }
          }
      EON
      nginx -g "daemon off;"
      EOF'
    labels:
    - "traefik.http.routers.api-http.rule=PathPrefix(`/api`) || PathPrefix(`/webdav`) || PathPrefix(`/share`) || PathPrefix(`/wopi`) || PathPrefix(`/openapi`)"
    - "traefik.http.routers.api-https.rule=PathPrefix(`/api`) || PathPrefix(`/webdav`) || PathPrefix(`/share`) || PathPrefix(`/wopi`) || PathPrefix(`/openapi`)"
    - "traefik.http.routers.api-https.tls"
  balloon-web:
    image: gyselroth/balloon-web:3.2.12
    networks:
    - backend
    - frontend
    labels:
    - "traefik.http.routers.webui-http.rule=PathPrefix(`/`)"
    - "traefik.http.routers.webui-https.rule=PathPrefix(`/`)"
    - "traefik.http.routers.webui-https.tls"
  balloon-upgrade:
    image: gyselroth/balloon:latest-dev
    volumes:
    - .:/srv/www/balloon
    entrypoint: /srv/www/balloon/src/cgi-bin/cli.php upgrade -vvvv
    networks:
    - backend
    environment: &env
      - BALLOON_MONGODB_URI=mongodb://mongodb:27017
      - BALLOON_CLAMAV_URI=tcp://clamav:3310
      - BALLOON_ELASTICSEARCH_URI=http://elasticsearch:9200
      - BALLOON_LIBREOFFICE_COLLAB_URL=http://libreoffice-collab:9980
      - BALLOON_LIBREOFFICE_COLLAB_WOPI_URL=http://balloon-proxy/wopi
      - BALLOON_LIBREOFFICE_CONVERT_URL=http://libreoffice-convert:9980
      - BALLOON_SMTP_HOST=postfix
      - BALLOON_URL=http://localhost:8080
      - BALLOON_BURL_BROWSERLESS_URL=http://browserless:3000
  balloon-deps:
    image: gyselroth/balloon:latest-dev
    volumes:
    - .:/srv/www/balloon
    entrypoint: make dep
  balloon-ws:
    image: gyselroth/balloon:latest-dev
    volumes:
    - .:/srv/www/balloon
    entrypoint: php-fpm
    networks:
    - backend
    environment: *env
    labels:
    #overwrite port 9000 because of php-fpm
    - "traefik.http.services.balloon-ws.loadbalancer.server.port=80"
    - "traefik.http.routers.ws-http.rule=PathPrefix(`/ws`)"
    - "traefik.http.routers.ws-https.rule=PathPrefix(`/ws`)"
    - "traefik.http.routers.ws-https.tls"
  balloon-api:
    image: gyselroth/balloon:latest-dev
    volumes:
    - .:/srv/www/balloon
    entrypoint: php-fpm
    networks:
    - backend
    environment: *env
  hydra-migrate:
    image: oryd/hydra:latest
    environment:
      - DSN=postgres://hydra:secret@postgresd:5432/hydra?sslmode=disable&max_conns=20&max_idle_conns=4
    command:
      migrate sql -e --yes
    restart: on-failure
  hydra:
    image: oryd/hydra:latest
    depends_on:
      - hydra-migrate
    ports:
      - "4444:4444" # Public port
      - "4445:4445" # Admin port
      - "5555:5555" # Port for hydra token user
    command:
      serve all --dangerous-force-http
    environment:
      - SERVE_PUBLIC_CORS_ENABLED=true
      - SERVE_PUBLIC_CORS_DEBUG=true
      - SERVE_PUBLIC_CORS_ALLOWED_ORIGINS=*
      - URLS_SELF_ISSUER=http://localhost:8084
      - URLS_CONSENT=http://localhost:8084/consent
      - URLS_LOGIN=http://localhost:8084/login
      - URLS_LOGOUT=http://localhost:8084/logout
      - DSN=postgres://hydra:secret@postgresd:5432/hydra?sslmode=disable&max_conns=20&max_idle_conns=4
      - SECRETS_SYSTEM=youReallyNeedToChangeThis
      - OIDC_SUBJECT_TYPES_SUPPORTED=public,pairwise
      - OIDC_SUBJECT_TYPE_PAIRWISE_SALT=youReallyNeedToChangeThis
    restart: unless-stopped
    networks:
    - backend
    - frontend
    labels:
    - "traefik.http.routers.oidc-http.rule=PathPrefix(`/.well-known/openid-configuration`) || PathPrefix(`/userinfo`) || PathPrefix(`/.well-known/jwks.json`) || PathPrefix(`/oauth2`)"
    - "traefik.http.routers.oidc-https.rule=PathPrefix(`/.well-known/openid-configuration`) || PathPrefix(`/userinfo`) || PathPrefix(`/.well-known/jwks.json`) || PathPrefix(`/oauth2`)"
    - "traefik.http.routers.oidc-https.tls"
  postgresd:
    image: postgres:9.6
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=hydra
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=hydra
    networks:
    - backend
    - frontend
  balloon-auth-consent:
    environment:
      - HYDRA_ADMIN_URL=http://hydra:4445
      - BALLOON_AUTH_URL=http://balloon-proxy/auth
    image: gyselroth/balloon-auth:latest-dev
    restart: unless-stopped
    networks:
    - backend
    - frontend
    labels:
    - "traefik.http.routers.consent-http.rule=PathPrefix(`/consent`) || PathPrefix(`/login`) || PathPrefix(`/logout`)"
    - "traefik.http.routers.consent-https.rule=PathPrefix(`/consent`) || PathPrefix(`/login`) || PathPrefix(`/logout`)"
    - "traefik.http.routers.consent-https.tls"
